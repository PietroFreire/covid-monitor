<!DOCTYPE html>
<html>

    <head>
        <title>Relat칩rio Gerencial</title>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
        <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
        <link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="style/login.css">
        <script src="js/script.js"></script>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
        <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>

        <style>
            a{
                color: white;
            }

            a:hover{
                color: purple;
                text-decoration: none;
            }

            .linha-vertical {
                height: auto;/*Altura da linha*/
                border-left: 1px solid;/* Adiciona borda esquerda na div como ser fosse uma linha.*/
            }

        </style>
    </head>

    <body>

        <div class="pos-f-t">
            <div class="pos-f-t">
                <div class="collapse" id="navbarToggleExternalContent">
                    <div style="background-color: #373b3d;">
                        <div class="row d-flex justify-content-center align-itens-center">
                            <div class="col md-auto hide" id="divCadFuncs" style="text-align: center;">
                                <a href="gerenciarFuncionario.html">Cadastro de Funcion치rios</a>
                                <div class="box linha-vertical hide "> </div>
                            </div>
                            <div class="col md-auto hide" id="divCadAlunos" style="text-align: center;">
                                <a href="gerenciarAluno.html">Cadastro de Alunos</a>
                                <div class="box linha-vertical hide "> </div>
                            </div>
                            <div class="col md-auto hide" id="divCadSintomas" style="text-align: center;">
                                <a href="sintoma.html">Cadastro de Sintomas</a>
                                <div class="box linha-vertical hide "> </div>
                            </div>
                            <div class="col md-auto hide" id="divRelatorios" style="text-align: center;">
                                <a href="relatorios.html">Relat칩rios</a>
                                <div class="box linha-vertical hide "> </div>
                            </div>
                            <div class="col md-auto" id="divHistorico" style="text-align: center;">
                                <a href="historico.html">Hist칩rico</a>
                                <div class="box linha-vertical hide "> </div>
                            </div>
                            <div class="col md-auto" style="text-align: center;">
                                <a href="index.html">Sair</a>
                            </div>
                        </div>
                    </div>
                </div>
                <nav style="background-color: #373b3d;" class="navbar navbar-dark d-flex">
                    <h3 style="color: white;">Covid-Monitor</h3>
                    <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarToggleExternalContent" aria-controls="navbarToggleExternalContent" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                </nav>
            </div>
        </div>
        <header class="container mt-5">
            <div class="row">
                <div class="col-md-12">
                    <h3><b>Relat칩rio</b></h3>
                    <hr>
                </div>
                <div class="col-md-9">
                    <form>
                        <div class="row">
                            <div class="col form-group">
                              <label for="data-inicio">Data In칤cio</label>
                              <input name="data-inicio" type="date" class="form-control mx-0" placeholder="First name" id="data-inicio" value="2021-11-01">
                            </div>
                            <div class="col form-group">
                              <label for="data-fim">Data Fim</label>
                              <input name="data-fim" type="date" class="form-control mx-0" placeholder="Last name" id="data-fim">
                            </div>
                            <div class="col-2 form-group">
                                <label class="d-block" for="filtrar-registros">&nbsp;</label>
                                <button type="button" class="btn-primary mt-2" onclick="getUsuarios()" id="filtrar-registros">Filtrar</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </header>


        <div class="container d-flex w-100 h-100 p-3 mx-auto justify-content-center flex-column">
            <div class="pt-5 mx-auto clean-table w-100"> <!-- ================================== -->
                <center><canvas id="myChart" style="text-align: center;"></canvas></center>
            </div>
        </div>

        <footer>
            <p><span style="color: purple">춸Copyright</span> - Covid-Monitor 2020 | Desenvolvido com 游눞 por Amanda, Gustavo, Israel e Gabriel</p>
        </footer>

        <script>

            const divCadFunc = document.querySelector('#divCadFuncs');
            const divCadAluno = document.querySelector('#divCadAlunos');
            const divCadSintoma = document.querySelector('#divCadSintomas');
            const divRelatorios = document.querySelector('#divRelatorios');
            const todos_sintomas = document.querySelector('#step_sintoma');

            // Encontra dados

            getUsuarios();
            targets();

            function targets(){
                const currentRole = localStorage.getItem('role');
                if(currentRole == 2) {
                    divRelatorios.classList.remove('hide');
                }else if(currentRole == 3){
                    divCadFunc.classList.remove('hide');
                    divCadAluno.classList.remove('hide');
                    divCadSintoma.classList.remove('hide');
                    divRelatorios.classList.remove('hide');
                    divCadSintoma.classList.remove('hide');
                }
            }

            async function getUsuarios() {
                labels = [];
                dados = [];
                dataAux = []

                const dateInicio = document.querySelector('#data-inicio');
                const dateFim = document.querySelector('#data-fim');
                const currentUser = localStorage.getItem('userID');

                diaInicio = new Date(dateInicio.value);
                if (dateFim.value == ""){
                    diaFim = new Date(Date.now()+86400000);
                } else {
                    diaFim = new Date(dateFim.value);
                }
                dataDif = diaFim - diaInicio;
                diaDif = (dataDif-dataDif%86400000)/86400000;
                for (i=1; i <= diaDif; i++){
                    dados.push(0); // Cria array de dados com 0
                    dataIterator = new Date(diaFim - (diaFim%86400000) - (diaDif-i+1)*86400000);
                    labels.push(dataIterator.getUTCDate()+"-"+(dataIterator.getUTCMonth()+1)+"-"+dataIterator.getUTCFullYear()); // Cria array de labels
                    dataAux.push(dataIterator); //
                }

                let URL = `/api/estadoSaude/membro/${currentUser}`;
                if(dateInicio.value && !dateFim.value){
                    URL += '?start='+dateInicio.value
                } else {
                    URL += '?start='+dateInicio.value+"&end="+dateFim.value
                }
                fetch(URL)
                    .then(resposta => { if (!resposta.ok) throw Error(resposta.status); return resposta;})
                    .then(resposta => resposta.json())
                    .then(jsonResponse => getReg(jsonResponse))
                    .catch(function(error) { console.log("Erro ao listar usu치rios (c칩digo " + error.message + ")");});
            }
            function getReg( registros ) {
                
                let n = registros.length;
                for (let i = 0; i < n; i++) {
                    let dado = registros[i];
                    let registroSaude = dado.isBem;
                    let data = new Date(dado.dtCriacao);
                    checkAno = data.getFullYear();
                    checkMes = data.getMonth();
                    checkDia = data.getDate();
                    for(j = 0; j < diaDif; j++){
                        dataAuxDia = new Date(dataAux[j-1]);
                        if (checkAno == dataAuxDia.getUTCFullYear() &&
                            checkMes == dataAuxDia.getUTCMonth() &&
                            checkDia == dataAuxDia.getUTCDate()) { 
                            dados[j]++;
                        } // Adiciona mais um registro no dia
                    }
                }
                //console.log(dados);
                chart();
            }

            function chart(){
                // Tratamento do gr치fico
                //labels = ['Janeiro','Fevereiro','Mar칞o','Abril','Maio','Junho','Julho']; // exemplos
                //dados = [65, 59, 80, 81, 56, 55, 40];

                const data = {
                    labels: labels,
                    datasets: [{
                        label: 'Registros por dia',
                        data: dados,
                        backgroundColor: 'rgba(0, 0, 200, 0.7)'
                    }]
                };

                // Configura칞칚o do gr치fico
                const config = {
                    type: 'bar',
                    data: data,
                    options: {
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        }
                    }
                };

                myChart = new Chart(
                    document.getElementById('myChart'),
                    config
                );
            }

        </script>
    </body>

</html>
